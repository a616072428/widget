<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>商城商品</title>
    <link rel="stylesheet" href="../../css/api.css" />
    <link rel="stylesheet" href="../../css/commonWindow.css" />
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        html,body{
            width: 100%;
            height: auto;
            overflow: scroll;
            background: #ffffff;
            position: relative;
        }
        #contentDom{
            padding-top: 136px;
        }


        .list-content{
            overflow: hidden;
            width: 100%;
            padding:0 19px;
            box-sizing: border-box;
        }
        .list-content li{
            width:48%;
            margin-bottom: 40px;
            /*height: 415px;*/
            overflow: hidden;
            position: relative;
        }
        .collect{
            position: absolute;
            width: 20px;height: 20px;
            right: 12px;top: 14px;
            background: url("../../icon/collectno.png") no-repeat center;
            background-size: 100%;
        }
        .collect.active{
            background: url("../../icon/collectyes.png") no-repeat center;
            background-size: 100%;
        }


        .list-content li:nth-of-type(2n+1){
            float: left;
        }
        .list-content li:nth-of-type(2n){
            float: right;
        }

        .list-content li .img{
            width: 100%;
            height: 160px;
            overflow: hidden;
        }
        .list-content li  img{
            display: block;
        }
        .list-content li  p{
            margin-top: 19px;
            font-family: TeluguMN-Bold;
            font-size: 15px;
            color: #111111;
            letter-spacing: 0;
            line-height: 18px;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .list-content li span{
            line-height: 18px;
            display: block;
            font-family: PingFangSC-Regular;
            font-size: 13px;
            color: #717171;
            letter-spacing: 0;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .list-content li i{
            margin-top: 9px;
            display: block;
            font-family: STHeitiSC-Medium;
            font-size: 17px;
            color: #2E2E2E;
            letter-spacing: 0;
            text-align: center;
        }
        /*导航*/
        .sortBtn{
            width: 100%;
            overflow: hidden;
            position: fixed;
            background: #fff;
            top: 135px;
            /*transition: .3s;*/
            left: 0;
            z-index: 999;
        }
        .sortBtn ul{
            width: 100%;
            padding: 14px 19px;box-sizing: border-box;
            display: flex;
            justify-content: space-between;
        }
        .sortBtn li{
            padding-bottom: 3px;
            font-size: 13px;
            color: #9B9B9B;
            border-bottom: 1px solid #fff;
        }
        .sortBtn li em{
            width: 6px;height: 13px;
            margin-left: 2px;
            background: url("../../icon/sort3.png") no-repeat 0 0;
            vertical-align: middle;
            background-size: 100%;
        }

        .sortBtn li.active{
            color: #505050;
            border-bottom: 1px solid #505050;;
        }
        #mainTrends{
            padding-top: 89px;
            display: none;
        }
        .trends-list{
            padding:6px 19px 0 19px;
            margin-top: 21px;
        }
        .trends-header > div{
            width: 44px;
            height: 44px;
            overflow: hidden;
            float: left;
        }
        .trends-header > div > img{
            width: 100%;
            height: 100%;
        }
        .trends-header > span{
            font-family: PingFangSC-Regular;
            font-size: 14px;
            color: #222222;
            letter-spacing: 0;
            margin-left:12px;
            margin-top: 6px;
        }
        .trends-header > p{
            font-family: PingFangSC-Regular;
            font-size: 12px;
            color: #BBBBBB;
            letter-spacing: 0;
            text-align: left;
            margin-left: 56px;
        }
        .trends-list > p{
            font-family: PingFangSC-Regular;
            font-size: 12px;
            color: #505050;
            letter-spacing: 0;
            text-align: left;
            overflow:hidden;
            text-overflow:ellipsis;
            display:-webkit-box;
            -webkit-box-orient:vertical;
            -webkit-line-clamp:2;
            margin: 15px 0 11px 0;
        }

        .imgBox{
            overflow: hidden;
            float: left;
        }
        .imgBox1{
            height: 278px;
            width: 100%;
        }
        .imgBox2{
            width: 49%;
            height: 139px;
        }
        .imgBox3{
            height: 139px;
            width: 32%;
        }

        .imgWrap{
            width: 100%;
            height: 139px;
            margin: 2px 0 2px 0;
        }
        .imgWrap > li:nth-child(2){
            margin:0 2px 0 2px;
        }
    </style>
</head>
<body>
<div id="main">
    <!-- 列表内容 -->
    <ul class="list-content" id="contentDom">

    </ul>
    <div id="mainTrends">

    </div>
</div>
<script type="text/javascript" src="../../lib/script/quakooLib/QuakooBase-1.0.0.js"></script>
<script type="text/javascript" src="../../lib/script/quakooLib/QuakooConfig-1.0.0.js"></script>
<script type="text/javascript" src="../../lib/script/quakooLib/QuakooBaseApp-1.0.0.js"></script>
<script type="text/javascript" src="../../lib/script/quakooLib/QuakooBaseAppBusiness-1.0.0.js"></script>
<script type="text/javascript" src="../../lib/script/quakoo/Config.js"></script>
<script type="text/javascript" src="../../lib/script/quakoo/project.js"></script>


<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/template-native.js"></script>
<script type="text/javascript" src="../../script/echo.min.js"></script>
<!--商品模板-->
<script type="text/html" id="contentTmp">
    <%for(var i = 0; i < list.length; i++){%>
        <li onclick="openIndex('<%=list[i].id%>','<%=list[i].title%>')">
            <div class="img">
                <img data-echo="<%=list[i].covers[0]%>" alt="" real-style="<%=list[i].style%>">
            </div>
            <p><%=list[i].title%></p>
            <span><%=list[i].name%></span>
            <i>￥<%=list[i].price%></i>
            <%if(list[i].favorite){%>
            <em class="collect active" onclick="toCollect('<%=list[i].id%>',1,this)"></em>
            <%}else{%>
            <em class="collect" onclick="toCollect('<%=list[i].id%>',2,this)"></em>
            <%}%>
        </li>
    <%}%>
</script>
<!--动态模板-->
<script type="text/html" id="contentTmpTrends">
    <%if(list){%>
    <%for(var i = 0; i < list.length; i++){%>
    <div class="trends-list" onclick="openInfo('<%=list[i].id%>')">
        <div class="trends-header">
            <div>
                <img onerror="this.src='../../icon/myIcon.png'" alt="" src="<%=list[i].thirdIcon%>" style="<%=list[i].style%>" >
            </div>
            <span><%=list[i].thirdName%></span>
            <p><%=list[i].Ctime%></p>
        </div>
        <p><%=list[i].content%></p>
        <%if(list[i].tailorImg.length>0){%>
        <%if(list[i].tailorImg.length==1){%>
        <ul class="imgWrap" style="height:278px;">
            <li class="imgBox imgBox1">
                <img src="<%=list[i].tailorImg[0]%>" style="<%=list[i].style[0]%>" alt="">
            </li>
        </ul>
        <%}else if(list[i].tailorImg.length==2){%>
        <ul class="imgWrap" style="height:278px;">
            <li class="imgBox imgBox2" style="height:278px;">
                <img src="<%=list[i].tailorImg[0]%>" style="<%=list[i].style[0]%>" alt="">
            </li>
            <li class="imgBox imgBox2" style="height:278px;">
                <img src="<%=list[i].tailorImg[1]%>" style="<%=list[i].style[1]%>" alt="">
            </li>
        </ul>
        <%}else if(list[i].tailorImg.length==3){%>
        <ul class="imgWrap">
            <li class="imgBox imgBox3">
                <img src="<%=list[i].tailorImg[0]%>" style="<%=list[i].style[0]%>" alt="">
            </li>
            <li class="imgBox imgBox3">
                <img src="<%=list[i].tailorImg[1]%>" style="<%=list[i].style[1]%>" alt="">
            </li>
            <li class="imgBox imgBox3">
                <img src="<%=list[i].tailorImg[2]%>" style="<%=list[i].style[2]%>" alt="">
            </li>
        </ul>
        <%}else if(list[i].tailorImg.length==4){%>
        <ul class="imgWrap">
            <li class="imgBox imgBox2">
                <img src="<%=list[i].tailorImg[0]%>" style="<%=list[i].style[0]%>" alt="">
            </li>
            <li class="imgBox imgBox2">
                <img src="<%=list[i].tailorImg[1]%>" style="<%=list[i].style[1]%>" alt="">
            </li>
        </ul>
        <ul class="imgWrap">
            <li class="imgBox imgBox2">
                <img src="<%=list[i].tailorImg[2]%>" style="<%=list[i].style[2]%>" alt="">
            </li>
            <li class="imgBox imgBox2">
                <img src="<%=list[i].tailorImg[3]%>" style="<%=list[i].style[3]%>" alt="">
            </li>
        </ul>
        <%}else{%>
        <ul class="imgWrap">
            <li class="imgBox imgBox3">
                <img src="<%=list[i].tailorImg[0]%>" style="<%=list[i].style[0]%>" alt="">
            </li>
            <li class="imgBox imgBox3">
                <img src="<%=list[i].tailorImg[1]%>" style="<%=list[i].style[1]%>" alt="">
            </li>
            <li class="imgBox imgBox3">
                <img src="<%=list[i].tailorImg[2]%>" style="<%=list[i].style[2]%>" alt="">
            </li>
        </ul>
        <ul class="imgWrap">
            <%for(var k= 0; k < list[i].tailorImg.length-3; k++){%>
            <li class="imgBox imgBox3">
                <img src="<%=list[i].tailorImg[3+k]%>" style="<%=list[i].style[3+k]%>" alt="">
            </li>
            <%}%>
        </ul>
        <%}%>
        <%}%>
    </div>
    <%}%>
    <%}%>
</script>
<script>
    var nowIndex=0;
    var showDynamic = false;
    apiready = function(){
        navSwitch(4);
        document.onscroll = function () {
            pageScroll()
        }
        if(api.pageParam.showDynamic){
            changeBody(1)
        }else{
            changeBody(0)
        }
    }

    function changeBody(index) {
        nowIndex = index;
        pageScroll()
        if(index==0){
            document.getElementById('contentDom').style.display = 'block';
            document.getElementById('mainTrends').style.display = 'none';
        }else if(index==1){
            if(!showDynamic){
                //获取店铺动态
                new QuakooPage(addDataToHtmlTrends,config.getUrl_web_mall_getThirdDynamic(),{type:1,thirdId:parseInt(api.pageParam.id)});
            }
            document.getElementById('contentDom').style.display = 'none';
            document.getElementById('mainTrends').style.display = 'block';
        }
    }

    //导航切换
    function navSwitch(sort){
        //根据店铺id 类型获取商品
        new QuakooPage(addDataToHtml,config.getUrl_web_mall_getStoreOfGoods(),{sid:parseInt(api.pageParam.id), sort: sort})
    };
    function pageScroll() {
        if(nowIndex==0){
            if(quakooUtils.getScrollTop()>150){
                if(quakooDb.getItem('store_head')){
                    api.execScript({
                        name:api.winName,
                        frameName:"store_head",
                        script:"changeLayout()"
                    })
                }
                api.setFrameAttr({
                    name: 'store_head',
                    rect:{
                        x:0,
                        marginTop: 0,
                        w: 'auto',
                        h: api.pageParam.top + 45 + 92
                    }
                });
            }else{
                if(quakooUtils.getScrollTop()<80){
                    if(quakooDb.getItem('store_head')){
                        api.execScript({
                            name:api.winName,
                            frameName:"store_head",
                            script:"changeLayout(true)"
                        })
                    }
                    api.setFrameAttr({
                        name: 'store_head',
                        rect:{
                            x:0,
                            marginTop: 0,
                            w: 'auto',
                            h: api.pageParam.top + 45 + 91 + 92
                        }
                    });
                }
            }
        }else if(nowIndex==1){
            if(quakooUtils.getScrollTop()>150){
                if(quakooDb.getItem('store_head')){
                    api.execScript({
                        name:api.winName,
                        frameName:"store_head",
                        script:"changeLayout()"
                    })
                }

                api.setFrameAttr({
                    name: 'store_head',
                    rect:{
                        x:0,
                        marginTop: 0,
                        w: 'auto',
                        h: api.pageParam.top + 45 + 44
                    }
                });
            }else{
                if(quakooUtils.getScrollTop()<80){
                    if(quakooDb.getItem('store_head')){
                        api.execScript({
                            name:api.winName,
                            frameName:"store_head",
                            script:"changeLayout(true)"
                        })
                    }
                    api.setFrameAttr({
                        name: 'store_head',
                        rect:{
                            x:0,
                            marginTop: 0,
                            w: 'auto',
                            h: api.pageParam.top + 45 + 91 + 44
                        }
                    });
                }
            }
        }

    }
    //商品模板渲染
    function addDataToHtml(results,append){
        if(results){
            for(var i=0;i<results.length;i++){
                var obj = quakooImg.processImg(results[i].covers[0],api.winWidth*0.48,api.winWidth*0.48);
                results[i].style = obj.style;
                results[i].covers[0] = obj.url;
                results[i].price = quakooUtils.formatMoney(results[i].price/100,2);
            }
            var data = {list: results};
            var html = template('contentTmp',data);
            if (append){
                var div = document.createElement("div");
                div.innerHTML = html;
                document.getElementById('contentDom').appendChild(div);
            } else {
                document.getElementById('contentDom').innerHTML = html;
            }
            api.parseTapmode();
            document.getElementById("main").style.display = "block";
            setTimeout(function(){
                if(!echo.isInit()){
                    echoExt.init({
                        offset: 0,
                        throttle: 0//设置图片延迟加载的时间
                    });
                }else{
                    echo.render();
                }
            },100)
        }
    }
    // 2 收藏     1取消收藏
    var collectFlag = true;
    function toCollect(id,favoriteFlag,self,e) {
        quakooUtils.stopEventBubble(e)
        if(!quakooUser.isLoginUser()){
            quakooApp.openNewWindow('login','../login/login.html',{});
            return ;
        }
        if(collectFlag){
            collectFlag = false;
            if(favoriteFlag==1){
                quakooMsg.showProgress();
                quakooData.ajaxSubmitData(config.getUrl_web_system_favoriteDelete(),{typeId:id,type:1},function (ret,err) {
                    quakooMsg.hideProgress();
                    collectFlag = true;
                    if(ret && ret.success){
                        quakooMsg.toast('取消成功');
                        self.classList.toggle('active');
                        self.onclick = function () {
                            toCollect(id,2,self)
                        }
                        api.execScript({
                            name:'main',
                            frameName:'my',
                            script:'editCollectNum("-")'
                        });
                    }else{
                        quakooMsg.toast(err.msg)
                    }
                })
            }else{
                quakooMsg.showProgress();
                quakooData.ajaxSubmitData(config.getUrl_web_system_favoriteAdd(),{typeId:id,type:1},function (ret,err) {
                    quakooMsg.hideProgress();
                    collectFlag = true;
                    if(ret && ret.success){
                        quakooMsg.toast('收藏成功');
                        self.classList.toggle('active');
                        self.onclick = function () {
                            toCollect(id,1,self)
                        }
                        api.execScript({
                            name:'main',
                            frameName:'my',
                            script:'editCollectNum("+")'
                        });
                    }else{
                        quakooMsg.toast(err.msg)
                    }
                })
            }
        }
    }
    function openIndex(id,title) {
        quakooApp.openNewWindow('goodsIndexStore','../goods/goodsIndex.html',{id:id,title:title});
    }

    //动态模板渲染
    function addDataToHtmlTrends(results,append){
        showDynamic = true;
        if(results){
            for(var j = 0; j < results.length;j++){
                results[j].Ctime = quakooUtils.formatTimeToDayDate(results[j].ctime)
                //处理头像
                if(results[j].icon){
                    var listicon = results[j].thirdIcon;
                    var size = 44;
                    var obj = quakooImg.processImg(listicon,size,size);
                    results[j].style = obj.style;
                    results[j].thirdIcon = obj.url;
                }
                //处理图片
                if (results[j].banners.length > 0) {
                    results[j].tailorImg=[];
                    results[j].style=[];
                    if (results[j].banners.length == 1) {
                        var width = api.winWidth - 38;
                        var height = 278;
                        var obj = quakooImg.processImg(results[j].banners[0], width, height)
                        results[j].tailorImg.push(obj.url);
                        results[j].style.push(obj.style);
                    } else if (results[j].banners.length == 2 || results[j].banners.length == 4) {
                        for (var k = 0; k < results[j].banners.length; k++) {
                            var width = (api.winWidth - 38-4) * 0.49;
                            var height ="";
                            if(results[j].banners.length == 2 ){
                                height = 278;
                            }else{
                                height = 139;
                            }
                            var obj = quakooImg.processImg(results[j].banners[k], width, height)
                            results[j].tailorImg.push(obj.url);
                            results[j].style.push(obj.style);
                        }
                    } else if (results[j].banners.length >= 3 && results[j].banners.length !== 4) {
                        for (var n = 0; n < results[j].banners.length; n++) {
                            var width = (api.winWidth - 38-4) * 0.32;
                            var height = 139;
                            var obj = quakooImg.processImg(results[j].banners[n], width, height);
                            results[j].tailorImg.push(obj.url);
                            results[j].style.push(obj.style);
                        }
                    }
                }

            }
            var data = {list: results};
            var html = template('contentTmpTrends',data);
            if (append){
                var div = document.createElement("div");
                div.innerHTML = html;
                document.getElementById('mainTrends').appendChild(div);
            } else {
                document.getElementById('mainTrends').innerHTML = html;
            }
            api.parseTapmode();
        }

    }
    //跳转动态详情
    function openInfo(id){
        quakooApp.openNewWindow('style_index','../style/style_index.html',{id:id},{slidBackEnabled:false});
    }
</script>
</body>
</html>
